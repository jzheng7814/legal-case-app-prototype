import React, { useCallback, useEffect, useMemo, useState } from 'react';
import { Trash2 } from 'lucide-react';
import { useChecklist, useDocuments, useHighlight } from '../state/WorkspaceProvider';

const ChecklistPanel = ({ isActive }) => {
    const { categories, isLoading, addItem, deleteItem } = useChecklist();
    const documents = useDocuments();
    const {
        selectedDocumentText,
        selectedDocumentRange,
        tooltipPosition,
        clearSelection,
        jumpToDocumentRange
    } = useHighlight();
    const [isPickerOpen, setIsPickerOpen] = useState(false);
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [actionError, setActionError] = useState(null);
    const [expandedEvidence, setExpandedEvidence] = useState(() => new Set());
    const [valueInput, setValueInput] = useState('');
    const [selectedCategoryId, setSelectedCategoryId] = useState('');

    useEffect(() => {
        if (!selectedDocumentText) {
            setIsPickerOpen(false);
        }
    }, [selectedDocumentText]);

    const selectionAvailable = Boolean(
        isActive &&
        selectedDocumentText &&
        selectedDocumentRange &&
        documents.selectedDocument != null
    );

    const handleDelete = useCallback(async (valueId) => {
        if (!valueId) {
            return;
        }
        setActionError(null);
        try {
            await deleteItem(valueId);
        } catch (error) {
            setActionError(error.message || 'Failed to delete checklist item.');
        }
    }, [deleteItem]);

    useEffect(() => {
        if (isPickerOpen && categories.length > 0 && !selectedCategoryId) {
            setSelectedCategoryId(categories[0].id);
        }
    }, [categories, isPickerOpen, selectedCategoryId]);

    const documentLookup = useMemo(() => {
        const map = {};
        (documents.documents || []).forEach((doc) => {
            map[doc.id] = doc;
        });
        return map;
    }, [documents.documents]);

    const resolveDocumentLabel = useCallback((documentId) => {
        if (documentId == null) {
            return 'No document reference';
        }
        if (documentId === -1) {
            return 'Summary';
        }
        const doc = documentLookup[documentId];
        if (doc) {
            return doc.title || doc.name || `Document ${documentId}`;
        }
        return `Document ${documentId}`;
    }, [documentLookup]);

    const extractEvidenceText = useCallback((value) => {
        const doc = documentLookup[value.documentId];
        if (
            !doc ||
            value.startOffset == null ||
            value.endOffset == null ||
            value.endOffset <= value.startOffset
        ) {
            return null;
        }
        const boundedStart = Math.max(0, Math.min(value.startOffset, doc.content.length));
        const boundedEnd = Math.max(boundedStart, Math.min(value.endOffset, doc.content.length));
        if (boundedEnd <= boundedStart) {
            return null;
        }
        return doc.content.slice(boundedStart, boundedEnd);
    }, [documentLookup]);

    const toggleEvidence = useCallback((valueId) => {
        setExpandedEvidence((current) => {
            const next = new Set(current);
            if (next.has(valueId)) {
                next.delete(valueId);
            } else {
                next.add(valueId);
            }
            return next;
        });
    }, []);

    const handleValueNavigate = useCallback((value) => {
        if (
            value.documentId == null ||
            value.startOffset == null ||
            value.endOffset == null ||
            value.endOffset <= value.startOffset
        ) {
            return;
        }
        jumpToDocumentRange({
            documentId: value.documentId,
            range: { start: value.startOffset, end: value.endOffset }
        });
    }, [jumpToDocumentRange]);

    const handleOpenModal = useCallback(() => {
        setActionError(null);
        setValueInput('');
        if (categories.length > 0) {
            setSelectedCategoryId(categories[0].id);
        }
        setIsPickerOpen(true);
    }, [categories]);

    const handleCloseModal = useCallback(() => {
        setIsPickerOpen(false);
        setIsSubmitting(false);
        setValueInput('');
    }, []);

    const handleSubmit = useCallback(async () => {
        if (!selectionAvailable) {
            setActionError('Select text in a document to add a checklist item.');
            return;
        }
        const trimmed = valueInput.trim();
        if (!trimmed) {
            setActionError('Checklist text is required.');
            return;
        }
        if (!selectedCategoryId) {
            setActionError('Select a checklist category.');
            return;
        }
        setIsSubmitting(true);
        setActionError(null);
        try {
            await addItem({
                categoryId: selectedCategoryId,
                text: trimmed,
                documentId: documents.selectedDocument,
                startOffset: selectedDocumentRange.start,
                endOffset: selectedDocumentRange.end
            });
            clearSelection();
            setIsPickerOpen(false);
            setValueInput('');
        } catch (error) {
            setActionError(error.message || 'Failed to add checklist item.');
        } finally {
            setIsSubmitting(false);
        }
    }, [addItem, clearSelection, documents.selectedDocument, selectedCategoryId, selectedDocumentRange, selectionAvailable, valueInput]);

    const renderSelectionTooltip = () => {
        if (!selectionAvailable || isPickerOpen) {
            return null;
        }
        const style = {
            left: tooltipPosition.x,
            top: tooltipPosition.y
        };
        return (
            <button
                type="button"
                className="fixed z-50 -translate-x-1/2 rounded-full bg-[var(--color-accent)] px-3 py-1 text-xs font-semibold text-[var(--color-text-inverse)] shadow-lg hover:bg-[var(--color-accent-hover)]"
                style={style}
                onClick={handleOpenModal}
            >
                + Add item
            </button>
        );
    };

    const sortedCategories = useMemo(() => categories, [categories]);
    const checklistStatus = documents.documentChecklistStatus;
    const isPendingFromDocs = checklistStatus === 'pending';
    const effectiveLoading = isLoading || isPendingFromDocs;
    const isChecklistReady = !effectiveLoading && sortedCategories.length > 0;

    return (
        <div className="h-full flex flex-col overflow-hidden bg-[var(--color-surface-panel)] border-r border-[var(--color-border)]">
            <div className="border-b border-[var(--color-border)] px-4 py-3">
                <div className="flex items-center justify-between">
                    <div>
                        <h2 className="text-base font-semibold text-[var(--color-text-primary)]">Document Checklist</h2>
                        <p className="text-xs text-[var(--color-text-muted)]">Review extracted items or add your own from document spans.</p>
                    </div>
                    {isLoading && (
                        <span className="text-xs text-[var(--color-accent)] font-medium">Loading…</span>
                    )}
                </div>
                <p className="mt-2 text-[11px] text-[var(--color-text-secondary)]">
                    Refine this checklist from document spans; generation pulls directly from here.
                </p>
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-[var(--color-surface-panel-alt)]">
                {!isChecklistReady ? (
                    <div className="text-xs text-[var(--color-text-muted)]">Loading checklist…</div>
                ) : (
                    sortedCategories.map((category) => (
                        <div
                            key={category.id}
                            className="rounded-lg border bg-[var(--color-surface-panel)] shadow-sm"
                            style={{ borderColor: `${category.color}33` }}
                        >
                            <div className="flex items-center justify-between border-b border-[var(--color-border)] px-3 py-2">
                                <div className="flex items-center gap-2">
                                    <span
                                        className="h-2.5 w-2.5 rounded-full"
                                        style={{ backgroundColor: category.color }}
                                    />
                                    <p className="text-sm font-semibold text-[var(--color-text-primary)]">{category.label}</p>
                                </div>
                                <span className="text-xs text-[var(--color-text-muted)]">{category.values.length} entries</span>
                            </div>
                            <div className="p-3 space-y-3">
                                {category.values.length === 0 ? (
                                    <p className="text-xs text-[var(--color-text-muted)]">Nothing captured yet.</p>
                                ) : (
                                    category.values.map((value) => (
                                        <div
                                            key={value.id}
                                            className="rounded border border-[var(--color-border)] bg-[var(--color-surface-panel-alt)] px-2 py-2"
                                        >
                                            {(() => {
                                                const evidenceText = extractEvidenceText(value);
                                                const canJump =
                                                    value.documentId != null &&
                                                    value.startOffset != null &&
                                                    value.endOffset != null &&
                                                    value.endOffset > value.startOffset;
                                                const isExpanded = expandedEvidence.has(value.id);
                                                const documentLabel = resolveDocumentLabel(value.documentId);
                                                return (
                                                    <>
                                                        <div className="flex items-start justify-between gap-3">
                                                            <div className="flex-1">
                                                                <p className="text-sm text-[var(--color-text-primary)]">
                                                                    {value.text || value.value || '—'}
                                                                </p>
                                                                <div className="mt-1 flex flex-wrap items-center gap-2 text-[11px] text-[var(--color-text-muted)]">
                                                                    <button
                                                                        type="button"
                                                                        onClick={() => canJump && handleValueNavigate(value)}
                                                                        disabled={!canJump}
                                                                        className={`text-left underline decoration-dotted ${
                                                                            canJump
                                                                                ? 'text-[var(--color-accent)] hover:text-[var(--color-accent-hover)]'
                                                                                : 'cursor-not-allowed'
                                                                        }`}
                                                                    >
                                                                        {documentLabel}
                                                                    </button>
                                                                    {evidenceText ? (
                                                                        <button
                                                                            type="button"
                                                                            onClick={() => toggleEvidence(value.id)}
                                                                            className="rounded border border-[var(--color-border)] bg-[var(--color-surface-panel)] px-2 py-1 text-[11px] text-[var(--color-text-secondary)] hover:border-[var(--color-border-strong)]"
                                                                        >
                                                                            {isExpanded ? 'Hide evidence' : 'Show evidence'}
                                                                        </button>
                                                                    ) : (
                                                                        <span className="text-[11px] text-[var(--color-text-muted)]">
                                                                            Evidence text unavailable
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            <button
                                                                type="button"
                                                                onClick={() => handleDelete(value.id)}
                                                                className="text-[var(--color-text-muted)] hover:text-[var(--color-danger)]"
                                                                title="Delete item"
                                                            >
                                                                <Trash2 className="h-4 w-4" />
                                                            </button>
                                                        </div>
                                                        {isExpanded && evidenceText && (
                                                            <div className="mt-2 rounded border border-[var(--color-border)] bg-[var(--color-surface-panel)] p-2 text-xs text-[var(--color-text-primary)]">
                                                                <pre className="whitespace-pre-wrap break-words font-mono text-[11px] leading-relaxed">
                                                                    {evidenceText}
                                                                </pre>
                                                            </div>
                                                        )}
                                                    </>
                                                );
                                            })()}
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    ))
                )}
                {actionError && (
                    <div className="rounded bg-[var(--color-danger-soft)] px-3 py-2 text-xs text-[var(--color-danger)]">
                        {actionError}
                    </div>
                )}
                {isPickerOpen && selectionAvailable && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-[var(--color-overlay-scrim)] px-4">
                        <div className="w-full max-w-xl rounded-lg border border-[var(--color-border)] bg-[var(--color-surface-panel)] shadow-2xl">
                            <div className="flex items-center justify-between border-b border-[var(--color-border)] px-4 py-3">
                                <div>
                                    <p className="text-sm font-semibold text-[var(--color-text-primary)]">Add checklist item</p>
                                    <p className="text-[11px] text-[var(--color-text-muted)]">Review the highlighted span and add your value.</p>
                                </div>
                                <button
                                    type="button"
                                    onClick={handleCloseModal}
                                    className="text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)]"
                                    disabled={isSubmitting}
                                >
                                    Close
                                </button>
                            </div>
                            <div className="px-4 py-3 space-y-3">
                                <div>
                                    <p className="text-xs font-semibold text-[var(--color-text-secondary)] mb-1">Selected text</p>
                                    <div className="max-h-32 overflow-y-auto rounded border border-[var(--color-border)] bg-[var(--color-surface-panel-alt)] p-2 text-xs text-[var(--color-text-primary)]">
                                        <pre className="whitespace-pre-wrap break-words font-mono text-[11px] leading-relaxed">
                                            {selectedDocumentText}
                                        </pre>
                                    </div>
                                </div>
                                <div>
                                    <label className="text-xs font-semibold text-[var(--color-text-secondary)] mb-1 block" htmlFor="checklist-category">
                                        Checklist category
                                    </label>
                                    <select
                                        id="checklist-category"
                                        value={selectedCategoryId}
                                        onChange={(event) => setSelectedCategoryId(event.target.value)}
                                        className="w-full rounded border border-[var(--color-input-border)] bg-[var(--color-input-bg)] px-3 py-2 text-sm text-[var(--color-text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--color-accent)]"
                                        disabled={isSubmitting}
                                    >
                                        {sortedCategories.map((category) => (
                                            <option key={category.id} value={category.id}>
                                                {category.label}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-semibold text-[var(--color-text-secondary)] mb-1 block" htmlFor="checklist-value">
                                        Checklist value
                                    </label>
                                    <textarea
                                        id="checklist-value"
                                        value={valueInput}
                                        onChange={(event) => setValueInput(event.target.value)}
                                        className="w-full min-h-[100px] rounded border border-[var(--color-input-border)] bg-[var(--color-input-bg)] px-3 py-2 text-sm text-[var(--color-text-primary)] focus:outline-none focus:ring-2 focus:ring-[var(--color-accent)]"
                                        placeholder="Describe the item in your own words…"
                                        disabled={isSubmitting}
                                    />
                                </div>
                            </div>
                            <div className="flex items-center justify-end gap-2 border-t border-[var(--color-border)] bg-[var(--color-surface-panel-alt)] px-4 py-3">
                                <button
                                    type="button"
                                    onClick={handleCloseModal}
                                    className="rounded border border-[var(--color-border)] px-3 py-1.5 text-sm text-[var(--color-text-secondary)] hover:border-[var(--color-border-strong)] disabled:opacity-50"
                                    disabled={isSubmitting}
                                >
                                    Cancel
                                </button>
                                <button
                                    type="button"
                                    onClick={handleSubmit}
                                    className="rounded bg-[var(--color-accent)] px-3 py-1.5 text-sm font-semibold text-[var(--color-text-inverse)] shadow hover:bg-[var(--color-accent-hover)] disabled:opacity-60"
                                    disabled={isSubmitting}
                                >
                                    {isSubmitting ? 'Saving…' : 'Save to checklist'}
                                </button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
            {renderSelectionTooltip()}
        </div>
    );
};

export default ChecklistPanel;
